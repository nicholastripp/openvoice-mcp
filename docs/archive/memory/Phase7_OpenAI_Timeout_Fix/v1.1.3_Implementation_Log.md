# Phase 7: OpenAI 30-Minute Session Timeout Fix (v1.1.3)

## Date: 2025-07-20

## Issue Summary

Users reported that after the assistant sat idle for approximately 30 minutes while waiting for a wake word, it would fail to create new OpenAI sessions with the error:
```
OpenAI error - Type: invalid_request_error, Message: Your session hit the maximum duration of 30 minutes., Code: session_expired
```

## Root Cause Analysis

1. **Persistent Connection at Startup**: The OpenAI WebSocket connection was established during `_initialize_components()` at application startup
2. **30-Minute Limit**: OpenAI enforces a maximum session duration of 30 minutes for Realtime API connections
3. **Idle Connection**: While waiting for wake words, the WebSocket remained connected but idle
4. **Timeout Expiration**: After 30 minutes, OpenAI would expire the session
5. **Failed Reconnection**: The reconnection logic in the OpenAI client had a bug where it would return success without actually reconnecting

## Solution Implemented

### 1. On-Demand Connection Strategy
- Removed OpenAI connection from startup initialization
- Connect only when a voice session starts (after wake word detection)
- Disconnect after each voice session completes

### 2. Fixed Reconnection Logic
- Modified `connect()` method in OpenAI client to check actual WebSocket status
- Previously only checked the ConnectionState enum, which could be out of sync
- Now verifies both state and actual WebSocket existence/status

### 3. Enhanced Session Management
- Each voice interaction gets a fresh OpenAI connection
- No idle connections consuming resources
- No possibility of hitting the 30-minute timeout

## Code Changes

### src/main.py

1. **Removed startup connection** (line ~993):
```python
# OLD: Connect at startup
success = await self.openai_client.connect()

# NEW: Just initialize, don't connect
self.logger.info("OpenAI client initialized (not connected - will connect on wake word)")
```

2. **Enhanced connection check in _start_session()** (lines ~1243-1250):
```python
# Added WebSocket status checking
ws_connected = self.openai_client.websocket is not None and not self.openai_client._is_websocket_closed()
if self.openai_client.state != ConnectionState.CONNECTED or not ws_connected:
    # Reconnect if either state or WebSocket indicates disconnection
```

3. **Simplified wake word handler** (line ~2810):
```python
# Removed connection logic from _on_wake_word_detected
# Let _start_session handle all connection management
```

### src/openai_client/realtime.py

1. **Fixed connect() method** (lines ~136-147):
```python
# Check actual WebSocket status, not just state enum
if self.websocket and not self._is_websocket_closed():
    if self.state == ConnectionState.CONNECTED:
        self.logger.debug("WebSocket is already connected and open")
        return True
```

## Testing Results

- No more 30-minute timeout errors
- Wake word detection works reliably after any idle period
- Clean connection/disconnection for each voice session
- Improved resource efficiency (no idle WebSocket connections)

## Version Updates

- Updated version to 1.1.3 in:
  - CHANGELOG.md
  - README.md
  - src/__init__.py
  - src/web/__init__.py
  - src/web/routes/setup.py

## Lessons Learned

1. **Connection Lifecycle**: Don't maintain persistent connections when they're not actively needed
2. **State Synchronization**: Always verify actual resource state, don't rely solely on state tracking variables
3. **API Limits**: Be aware of service provider timeout limits and design accordingly
4. **Debugging**: Enhanced logging was crucial for identifying the disconnect between state enum and actual WebSocket status