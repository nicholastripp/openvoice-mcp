{% extends "base.html" %}

{% block content %}
<div class="persona-container">
    <h1>Personality Editor</h1>
    
    <form id="persona-form">
        <!-- Identity Section -->
        <div class="form-section">
            <h2>Identity</h2>
            
            <label for="assistant_name">Assistant Name:</label>
            <input type="text" id="assistant_name" name="backstory.assistant name" 
                   value="{{ persona.BACKSTORY['assistant name'] | default('Ruby') }}" required>
            
            <label for="role">Role:</label>
            <input type="text" id="role" name="backstory.role" 
                   value="{{ persona.BACKSTORY.role | default('helpful home automation assistant') }}">
            
            <label for="personality">Personality:</label>
            <input type="text" id="personality" name="backstory.personality" 
                   value="{{ persona.BACKSTORY.personality | default('friendly and efficient') }}">
        </div>
        
        <!-- Personality Traits -->
        <div class="form-section">
            <h2>Personality Traits</h2>
            <p>Adjust these sliders to customize your assistant's personality:</p>
            
            {% for trait, description in traits.items() %}
            <div class="trait-slider">
                <label>
                    <span>{{ description }}</span>
                    <span class="range-value">{{ persona.PERSONALITY[trait] | default(50) }}</span>
                </label>
                <input type="range" name="personality.{{ trait }}" 
                       min="0" max="100" value="{{ persona.PERSONALITY[trait] | default(50) }}">
            </div>
            {% endfor %}
        </div>
        
        <!-- Backstory -->
        <div class="form-section">
            <h2>Backstory</h2>
            
            <label for="origin">Origin:</label>
            <textarea id="origin" name="backstory.origin" rows="2">{{ persona.BACKSTORY.origin | default('I am your Home Assistant voice companion') }}</textarea>
            
            <label for="purpose">Purpose:</label>
            <textarea id="purpose" name="backstory.purpose" rows="2">{{ persona.BACKSTORY.purpose | default('I help you control your smart home devices through natural conversation') }}</textarea>
            
            <label for="specialties">Specialties:</label>
            <input type="text" id="specialties" name="backstory.specialties" 
                   value="{{ persona.BACKSTORY.specialties | default('home automation, device control, status queries') }}">
        </div>
        
        <!-- Advanced Settings -->
        <div class="form-section">
            <h2>Advanced Settings</h2>
            
            <label for="instructions">Custom Instructions (optional):</label>
            <textarea id="instructions" name="meta.instructions" rows="4" 
                      placeholder="Leave blank to use auto-generated instructions">{{ persona.META.instructions | default('') }}</textarea>
            
            <label for="context">Additional Context:</label>
            <textarea id="context" name="meta.context" rows="3">{{ persona.META.context | default('You are integrated with Home Assistant and can control smart home devices, check device states, and answer questions about the home.') }}</textarea>
            
            <label for="style_notes">Response Style Guidelines:</label>
            <textarea id="style_notes" name="meta.style_notes" rows="3">{{ persona.META.style_notes | default('Keep responses concise but friendly. Always confirm actions you take. Be helpful and conversational.') }}</textarea>
        </div>
        
        <div class="button-group">
            <button type="submit" class="button primary">Save Personality</button>
            <button type="button" class="button" onclick="previewPersonality()">Preview</button>
            <button type="button" class="button" onclick="location.reload()">Cancel</button>
        </div>
    </form>
    
    <!-- Preview Modal -->
    <div id="preview-modal" class="modal" style="display: none;">
        <div class="modal-content">
            <h2>Personality Preview</h2>
            <div id="preview-samples">
                <p>Generating preview...</p>
            </div>
            <button onclick="closePreview()" class="button">Close</button>
        </div>
    </div>
</div>

<style>
.persona-container {
    max-width: 700px;
    margin: 0 auto;
}

.form-section {
    margin: 2rem 0;
    padding: 1.5rem;
    background: rgba(0,0,0,0.05);
    border-radius: 0.5rem;
}

input[type="text"], textarea {
    width: 100%;
    padding: 0.5rem;
    margin: 0.5rem 0 1rem;
}

textarea {
    resize: vertical;
}

.trait-slider {
    margin: 1.5rem 0;
}

.trait-slider label {
    display: flex;
    justify-content: space-between;
    margin-bottom: 0.5rem;
}

input[type="range"] {
    width: 100%;
}

.button-group {
    margin-top: 2rem;
    display: flex;
    gap: 1rem;
}

/* Modal styles */
.modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.5);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1000;
}

.modal-content {
    background: white;
    padding: 2rem;
    border-radius: 0.5rem;
    max-width: 600px;
    max-height: 80vh;
    overflow-y: auto;
}

#preview-samples {
    margin: 1.5rem 0;
    padding: 1rem;
    background: #f8f9fa;
    border-radius: 0.25rem;
}

.sample-response {
    margin: 1rem 0;
    padding: 1rem;
    background: white;
    border-left: 3px solid #007bff;
}
</style>

<script>
// Update range value displays
document.querySelectorAll('input[type="range"]').forEach(input => {
    const valueDisplay = input.parentElement.querySelector('.range-value');
    input.addEventListener('input', () => {
        valueDisplay.textContent = input.value;
    });
});

document.getElementById('persona-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const formData = new FormData(e.target);
    const data = {
        PERSONALITY: {},
        BACKSTORY: {},
        META: {}
    };
    
    // Process form data
    for (const [key, value] of formData.entries()) {
        const [section, ...fieldParts] = key.split('.');
        const field = fieldParts.join('.');
        
        if (section === 'personality') {
            data.PERSONALITY[field] = parseInt(value);
        } else if (section === 'backstory') {
            data.BACKSTORY[field] = value;
        } else if (section === 'meta') {
            data.META[field] = value;
        }
    }
    
    try {
        const response = await fetch('/api/persona/save', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(data)
        });
        
        const result = await response.json();
        
        if (result.status === 'success') {
            alert('Personality saved successfully!');
            location.reload();
        } else {
            alert('Error: ' + result.message);
        }
    } catch (error) {
        alert('Save failed: ' + error.message);
    }
});

async function previewPersonality() {
    const formData = new FormData(document.getElementById('persona-form'));
    const data = {};
    
    // Get current form values
    for (const [key, value] of formData.entries()) {
        if (key.startsWith('personality.')) {
            data[key.replace('personality.', '')] = parseInt(value);
        }
    }
    
    document.getElementById('preview-modal').style.display = 'flex';
    
    try {
        const response = await fetch('/api/persona/preview', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(data)
        });
        
        const result = await response.json();
        
        if (result.status === 'success') {
            const samplesHtml = result.samples.map(sample => 
                `<div class="sample-response">${sample}</div>`
            ).join('');
            
            document.getElementById('preview-samples').innerHTML = 
                '<h3>Sample Responses:</h3>' + samplesHtml;
        } else {
            document.getElementById('preview-samples').innerHTML = 
                '<p>Error generating preview: ' + result.message + '</p>';
        }
    } catch (error) {
        document.getElementById('preview-samples').innerHTML = 
            '<p>Error: ' + error.message + '</p>';
    }
}

function closePreview() {
    document.getElementById('preview-modal').style.display = 'none';
}
</script>
{% endblock %}