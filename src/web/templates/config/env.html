{% extends "base.html" %}

{% block content %}
<div class="config-container">
    <h1>Environment Variables</h1>
    
    <p class="warning">⚠️ API keys are masked for security. Enter new values to update them.</p>
    
    <form id="env-form">
        <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
        <div class="form-section">
            <h2>API Keys</h2>
            
            <label for="OPENAI_API_KEY">OpenAI API Key:</label>
            <input type="password" id="OPENAI_API_KEY" name="OPENAI_API_KEY" 
                   placeholder="sk-..." value="{{ env_vars.get('OPENAI_API_KEY', '') }}">
            
            <label for="HA_TOKEN">Home Assistant Token:</label>
            <input type="password" id="HA_TOKEN" name="HA_TOKEN" 
                   placeholder="eyJ0eXAiOiJKV1..." value="{{ env_vars.get('HA_TOKEN', '') }}">
            
            <label for="PICOVOICE_ACCESS_KEY">Picovoice Access Key:</label>
            <input type="password" id="PICOVOICE_ACCESS_KEY" name="PICOVOICE_ACCESS_KEY" 
                   placeholder="Access key..." value="{{ env_vars.get('PICOVOICE_ACCESS_KEY', '') }}">
        </div>
        
        <div class="form-section">
            <h2>URLs</h2>
            
            <label for="HA_URL">Home Assistant URL:</label>
            <input type="url" id="HA_URL" name="HA_URL" 
                   placeholder="http://homeassistant.local:8123" value="{{ env_vars.get('HA_URL', '') }}">
        </div>
        
        <div class="button-group">
            <button type="submit" class="button primary">Save Changes</button>
            <button type="button" class="button" onclick="location.reload()">Cancel</button>
        </div>
    </form>
</div>

<style>
.config-container {
    max-width: 600px;
    margin: 0 auto;
}

.warning {
    background: #fff3cd;
    border: 1px solid #ffeaa7;
    padding: 1rem;
    border-radius: 0.25rem;
    margin-bottom: 2rem;
}

.form-section {
    margin: 2rem 0;
}

input[type="password"],
input[type="url"] {
    width: 100%;
    padding: 0.5rem;
    margin: 0.5rem 0 1rem;
}

.button-group {
    margin-top: 2rem;
    display: flex;
    gap: 1rem;
}
</style>

<script>
document.getElementById('env-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const formData = new FormData(e.target);
    const data = {};
    
    // Only include non-empty values
    for (const [key, value] of formData.entries()) {
        if (value) {
            data[key] = value;
        }
    }
    
    // Include CSRF token
    const csrfToken = document.querySelector('input[name="csrf_token"]').value;
    
    try {
        const response = await fetch('/api/config/env', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRF-Token': csrfToken
            },
            body: JSON.stringify(data)
        });
        
        const result = await response.json();
        
        if (result.status === 'success') {
            alert('Environment variables updated successfully');
            location.reload();
        } else {
            alert('Error: ' + result.message);
        }
    } catch (error) {
        alert('Save failed: ' + error.message);
    }
});
</script>
{% endblock %}