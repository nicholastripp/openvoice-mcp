{% extends "base.html" %}

{% block content %}
<div class="config-container">
    <h1>Configuration Settings</h1>
    
    <form id="yaml-form">
        <!-- OpenAI Settings -->
        <div class="form-section">
            <h2>OpenAI Settings</h2>
            
            <label for="openai_voice">Voice:</label>
            <select id="openai_voice" name="openai.voice">
                <option value="alloy" {% if config.openai.voice == 'alloy' %}selected{% endif %}>Alloy</option>
                <option value="ash" {% if config.openai.voice == 'ash' %}selected{% endif %}>Ash</option>
                <option value="ballad" {% if config.openai.voice == 'ballad' %}selected{% endif %}>Ballad</option>
                <option value="coral" {% if config.openai.voice == 'coral' %}selected{% endif %}>Coral</option>
                <option value="echo" {% if config.openai.voice == 'echo' %}selected{% endif %}>Echo</option>
                <option value="sage" {% if config.openai.voice == 'sage' %}selected{% endif %}>Sage</option>
                <option value="shimmer" {% if config.openai.voice == 'shimmer' %}selected{% endif %}>Shimmer</option>
                <option value="verse" {% if config.openai.voice == 'verse' %}selected{% endif %}>Verse</option>
            </select>
            
            <label for="openai_temperature">Temperature (0.0-1.0):</label>
            <input type="range" id="openai_temperature" name="openai.temperature" 
                   min="0" max="1" step="0.1" value="{{ config.openai.temperature }}">
            <span class="range-value">{{ config.openai.temperature }}</span>
            
            <label for="openai_language">Language:</label>
            <input type="text" id="openai_language" name="openai.language" 
                   value="{{ config.openai.language }}" placeholder="en">
            
            <label for="openai_model">Model:</label>
            <select id="openai_model" name="openai.model">
                <option value="gpt-4o-mini-realtime-preview" {% if config.openai.model == 'gpt-4o-mini-realtime-preview' %}selected{% endif %}>GPT-4o Mini Realtime (Preview)</option>
                <option value="gpt-4o-realtime-preview" {% if config.openai.model == 'gpt-4o-realtime-preview' %}selected{% endif %}>GPT-4o Realtime (Preview)</option>
            </select>
            
            <label for="conversation_mode">Conversation Mode:</label>
            <select id="conversation_mode" name="session.conversation_mode">
                <option value="single_turn" {% if config.session.conversation_mode == 'single_turn' %}selected{% endif %}>Single Turn</option>
                <option value="multi_turn" {% if config.session.conversation_mode == 'multi_turn' %}selected{% endif %}>Multi Turn</option>
            </select>
            <small style="display: block; margin-top: -0.5rem; margin-bottom: 1rem; color: #666;">Single Turn: One question/response. Multi Turn: Continuous conversation.</small>
        </div>
        
        <!-- Audio Settings -->
        <div class="form-section">
            <h2>Audio Settings</h2>
            
            <label for="audio_input_volume">Input Volume:</label>
            <input type="range" id="audio_input_volume" name="audio.input_volume" 
                   min="0.1" max="5.0" step="0.1" value="{{ config.audio.input_volume }}">
            <span class="range-value">{{ config.audio.input_volume }}</span>
            
            <label for="audio_output_volume">Output Volume:</label>
            <input type="range" id="audio_output_volume" name="audio.output_volume" 
                   min="0.1" max="5.0" step="0.1" value="{{ config.audio.output_volume }}">
            <span class="range-value">{{ config.audio.output_volume }}</span>
            
            <label>
                <input type="checkbox" name="audio.agc_enabled" 
                       {% if config.audio.agc_enabled %}checked{% endif %}>
                Enable Automatic Gain Control (AGC)
            </label>
            
            <label>
                <input type="checkbox" name="audio.mute_during_response" 
                       {% if config.audio.mute_during_response %}checked{% endif %}>
                Mute microphone during response
            </label>
        </div>
        
        <!-- Wake Word Settings -->
        <div class="form-section">
            <h2>Wake Word Settings</h2>
            
            <label>
                <input type="checkbox" name="wake_word.enabled" 
                       {% if config.wake_word.enabled %}checked{% endif %}>
                Enable wake word detection
            </label>
            
            <label for="wake_word_sensitivity">Sensitivity:</label>
            <input type="range" id="wake_word_sensitivity" name="wake_word.sensitivity" 
                   min="0.1" max="2.0" step="0.1" value="{{ config.wake_word.sensitivity }}">
            <span class="range-value">{{ config.wake_word.sensitivity }}</span>
            
            <label>
                <input type="checkbox" name="wake_word.confirmation_beep_enabled" 
                       {% if config.wake_word.confirmation_beep_enabled %}checked{% endif %}>
                Play confirmation beep
            </label>
            
            <label for="wake_word_model">Wake Word:</label>
            <select id="wake_word_model" name="wake_word.model">
                <option value="alexa" {% if config.wake_word.model == 'alexa' %}selected{% endif %}>Alexa</option>
                <option value="americano" {% if config.wake_word.model == 'americano' %}selected{% endif %}>Americano</option>
                <option value="blueberry" {% if config.wake_word.model == 'blueberry' %}selected{% endif %}>Blueberry</option>
                <option value="bumblebee" {% if config.wake_word.model == 'bumblebee' %}selected{% endif %}>Bumblebee</option>
                <option value="computer" {% if config.wake_word.model == 'computer' %}selected{% endif %}>Computer</option>
                <option value="grapefruit" {% if config.wake_word.model == 'grapefruit' %}selected{% endif %}>Grapefruit</option>
                <option value="grasshopper" {% if config.wake_word.model == 'grasshopper' %}selected{% endif %}>Grasshopper</option>
                <option value="hey google" {% if config.wake_word.model == 'hey google' %}selected{% endif %}>Hey Google</option>
                <option value="hey siri" {% if config.wake_word.model == 'hey siri' %}selected{% endif %}>Hey Siri</option>
                <option value="jarvis" {% if config.wake_word.model == 'jarvis' %}selected{% endif %}>Jarvis</option>
                <option value="ok google" {% if config.wake_word.model == 'ok google' %}selected{% endif %}>OK Google</option>
                <option value="picovoice" {% if config.wake_word.model == 'picovoice' %}selected{% endif %}>Picovoice</option>
                <option value="porcupine" {% if config.wake_word.model == 'porcupine' %}selected{% endif %}>Porcupine</option>
                <option value="terminator" {% if config.wake_word.model == 'terminator' %}selected{% endif %}>Terminator</option>
                {% for custom in custom_wake_words %}
                <option value="{{ custom }}" {% if config.wake_word.model == custom %}selected{% endif %}>{{ custom.replace('.ppn', '').replace('_', ' ').replace('-', ' ').title() }} (custom)</option>
                {% endfor %}
            </select>
            
            <div class="upload-section">
                <h3>Upload Custom Wake Word Model</h3>
                <p>Upload a Porcupine wake word model (.ppn file)</p>
                <input type="file" id="wake_word_upload" accept=".ppn">
                <button type="button" class="button" onclick="uploadWakeWord()">Upload Model</button>
                <div id="upload_status"></div>
            </div>
        </div>
        
        
        <div class="button-group">
            <button type="submit" class="button primary">Save Changes</button>
            <button type="button" class="button" onclick="location.reload()">Cancel</button>
            <button type="button" class="button danger" onclick="restartApplication()" id="restart-button">Apply & Restart</button>
        </div>
    </form>
</div>

<style>
.config-container {
    max-width: 600px;
    margin: 0 auto;
}

.form-section {
    margin: 2rem 0;
    padding: 1.5rem;
    background: rgba(0,0,0,0.05);
    border-radius: 0.5rem;
}

select, input[type="text"], input[type="number"] {
    width: 100%;
    padding: 0.5rem;
    margin: 0.5rem 0 1rem;
}

input[type="range"] {
    width: calc(100% - 4rem);
    margin: 0.5rem 0 1rem;
}

label {
    display: block;
    margin-top: 1rem;
}

input[type="checkbox"] {
    margin-right: 0.5rem;
}

.button-group {
    margin-top: 2rem;
    display: flex;
    gap: 1rem;
}

.upload-section {
    margin-top: 1.5rem;
    padding: 1rem;
    background: rgba(0,0,0,0.03);
    border-radius: 0.25rem;
}

.upload-section h3 {
    margin-top: 0;
    font-size: 1.1rem;
}

#upload_status {
    margin-top: 0.5rem;
    font-style: italic;
}

.button.danger {
    background-color: #dc3545;
    color: white;
    border: 1px solid #dc3545;
}

.button.danger:hover {
    background-color: #c82333;
    border-color: #bd2130;
}

#restart-button {
    display: none;
}
</style>

<script>
// Update range value displays
document.querySelectorAll('input[type="range"]').forEach(input => {
    const valueDisplay = input.nextElementSibling;
    input.addEventListener('input', () => {
        valueDisplay.textContent = input.value;
    });
});

document.getElementById('yaml-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const formData = new FormData(e.target);
    const data = {};
    
    // Convert form data to nested object
    for (const [key, value] of formData.entries()) {
        const parts = key.split('.');
        let current = data;
        
        for (let i = 0; i < parts.length - 1; i++) {
            if (!current[parts[i]]) {
                current[parts[i]] = {};
            }
            current = current[parts[i]];
        }
        
        // Convert values to appropriate types
        if (value === 'on') {
            current[parts[parts.length - 1]] = true;
        } else if (!isNaN(value) && value !== '') {
            current[parts[parts.length - 1]] = parseFloat(value);
        } else {
            current[parts[parts.length - 1]] = value;
        }
    }
    
    // Handle unchecked checkboxes
    document.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
        if (!checkbox.checked) {
            const parts = checkbox.name.split('.');
            let current = data;
            
            for (let i = 0; i < parts.length - 1; i++) {
                if (!current[parts[i]]) {
                    current[parts[i]] = {};
                }
                current = current[parts[i]];
            }
            
            current[parts[parts.length - 1]] = false;
        }
    });
    
    try {
        const response = await fetch('/api/config/yaml', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(data)
        });
        
        const result = await response.json();
        
        if (result.status === 'success') {
            if (result.restart_required) {
                alert('Configuration saved successfully.\nRestart required for changes to take effect.');
                // Show restart button
                document.getElementById('restart-button').style.display = 'inline-block';
            } else {
                alert('Configuration saved successfully');
                location.reload();
            }
        } else {
            alert('Error: ' + result.message);
        }
    } catch (error) {
        alert('Save failed: ' + error.message);
    }
});

// Wake word upload function
async function uploadWakeWord() {
    const fileInput = document.getElementById('wake_word_upload');
    const statusDiv = document.getElementById('upload_status');
    
    if (!fileInput.files.length) {
        statusDiv.textContent = 'Please select a file';
        return;
    }
    
    const file = fileInput.files[0];
    if (!file.name.endsWith('.ppn')) {
        statusDiv.textContent = 'Invalid file type. Please upload a .ppn file';
        return;
    }
    
    const formData = new FormData();
    formData.append('file', file);
    
    statusDiv.textContent = 'Uploading...';
    
    try {
        const response = await fetch('/api/wake_word/upload', {
            method: 'POST',
            body: formData
        });
        
        const result = await response.json();
        
        if (result.status === 'success') {
            statusDiv.textContent = 'Upload successful! Reloading page...';
            setTimeout(() => location.reload(), 1500);
        } else {
            statusDiv.textContent = 'Upload failed: ' + result.message;
        }
    } catch (error) {
        statusDiv.textContent = 'Upload failed: ' + error.message;
    }
}

// Restart application function
async function restartApplication() {
    if (!confirm('This will restart the voice assistant. Are you sure?')) {
        return;
    }
    
    try {
        const response = await fetch('/api/system/restart', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'}
        });
        
        const result = await response.json();
        
        if (result.status === 'success') {
            alert('Application is restarting. Please wait a moment and refresh the page.');
            // Disable the restart button
            document.getElementById('restart-button').disabled = true;
            
            // Try to reconnect after a delay
            setTimeout(() => {
                checkConnection();
            }, 5000);
        } else {
            alert('Restart failed: ' + result.message);
        }
    } catch (error) {
        alert('Restart request failed: ' + error.message);
    }
}

// Check if the application is back online
function checkConnection() {
    fetch('/api/health')
        .then(() => {
            // Application is back online
            location.reload();
        })
        .catch(() => {
            // Still offline, try again
            setTimeout(checkConnection, 2000);
        });
}
</script>
{% endblock %}